name: BUILD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Linux (most archs supported)
          - os: linux
            arch: amd64
          - os: linux
            arch: arm64
          - os: linux
            arch: 386
          - os: linux
            arch: arm
          - os: linux
            arch: ppc64le
          - os: linux
            arch: riscv64
          # Windows (only amd64, 386, arm64)
          - os: windows
            arch: amd64
          - os: windows
            arch: 386
          - os: windows
            arch: arm64
          # Darwin (only amd64, arm64)
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64
          # FreeBSD (only amd64, 386, arm64)
          - os: freebsd
            arch: amd64
          - os: freebsd
            arch: 386
          - os: freebsd
            arch: arm64
    env:
      GOOS: ${{ matrix.os }}
      GOARCH: ${{ matrix.arch }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.1'

      - name: Install dependencies (fpm, dpkg, appimage)
        if: matrix.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential dpkg-dev libfuse2
          sudo gem install --no-document fpm
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          mv appimagetool-x86_64.AppImage /usr/local/bin/appimagetool

      - name: Build binary
        run: |
          mkdir -p dist
          EXT=""
          if [ "$GOOS" = "windows" ]; then EXT=".exe"; fi
          go build -o dist/aether-${GOOS}_${GOARCH}${EXT} ./cmd/aether2/

      - name: Package formats for Linux
        if: matrix.os == 'linux'
        run: |
          mkdir -p dist/pkgroot/usr/local/bin
          cp dist/aether-${GOOS}_${GOARCH} dist/pkgroot/usr/local/bin/aether

          # .deb
          mkdir -p dist/deb/DEBIAN
          cat > dist/deb/DEBIAN/control <<EOF
          Package: aether
          Version: 1.0.0
          Section: base
          Priority: optional
          Architecture: ${GOARCH}
          Maintainer: Aether Dev <noreply@aether.org>
          Description: Aether Programming Language Binary
          EOF
          mkdir -p dist/deb/usr/local/bin
          cp dist/aether-${GOOS}_${GOARCH} dist/deb/usr/local/bin/aether
          dpkg-deb --build dist/deb dist/aether-${GOOS}_${GOARCH}.deb

          # .rpm using fpm
          fpm -s dir -t rpm -n aether -v 1.0.0 --architecture ${GOARCH} --prefix /usr/local/bin -p dist/aether-${GOOS}_${GOARCH}.rpm dist/aether-${GOOS}_${GOARCH}=/usr/local/bin/aether

          # .appimage
          if [ "$GOARCH" != "riscv64" ] && [ "$GOARCH" != "ppc64le" ]; then
            mkdir -p AppDir/usr/bin
            cp dist/aether-${GOOS}_${GOARCH} AppDir/usr/bin/aether
            cp assets/icon-256x256.png AppDir/icon-256x256.png
            cat > AppDir/aether.desktop <<EOF
          [Desktop Entry]
          Name=Aether
          Exec=aether
          Icon=icon-256x256
          Type=Application
          Categories=Development;
          EOF

            ARCH="$GOARCH"
            if [ "$GOARCH" = "amd64" ]; then ARCH="x86_64"; fi
            if [ "$GOARCH" = "386" ]; then ARCH="i686"; fi
            if [ "$GOARCH" = "arm" ]; then ARCH="armhf"; fi
            if [ "$GOARCH" = "arm64" ]; then ARCH="arm_aarch64"; fi
            if [ "$GOARCH" = "ppc64le" ]; then ARCH="ppc64le"; fi

            export ARCH
            appimagetool AppDir dist/aether-"${GOOS}"_"${GOARCH}".appimage
          else
            echo "Skipping AppImage build for $GOARCH - not supported"
          fi
          # .tar
          mkdir -p tarball
          cp dist/aether-${GOOS}_${GOARCH} tarball/aether
          tar -cvf dist/aether-${GOOS}_${GOARCH}.tar -C tarball aether

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binary
          path: |
            dist/aether-${{ matrix.os }}_${{ matrix.arch }}
            dist/aether-${{ matrix.os }}_${{ matrix.arch }}.tar
            dist/aether-${{ matrix.os }}_${{ matrix.arch }}.deb
            dist/aether-${{ matrix.os }}_${{ matrix.arch }}.rpm
            dist/aether-${{ matrix.os }}_${{ matrix.arch }}.appimage
            dist/aether-${{ matrix.os }}_${{ matrix.arch }}.exe

            dist/aether-${{ matrix.os }}_${{ matrix.arch }}.appimage
            dist/aether-${{ matrix.os }}_${{ matrix.arch }}.exe
