name: CI + Release

on:
  push:
    branches: [ "main", "test" ]
    tags:
      - '*'
  pull_request:
    branches: [ "main", "test" ]

jobs:
  build:
    strategy:
      matrix:
        include:
          # Linux builds
          - os: linux
            arch: amd64
            runner: ubuntu-latest
          - os: linux
            arch: arm64
            runner: ubuntu-latest
          - os: linux
            arch: 386
            runner: ubuntu-latest
          - os: linux
            arch: arm
            runner: ubuntu-latest
          - os: linux
            arch: ppc64le
            runner: ubuntu-latest
          - os: linux
            arch: riscv64
            runner: ubuntu-latest
          # Windows builds
          - os: windows
            arch: amd64
            runner: ubuntu-latest
          - os: windows
            arch: 386
            runner: ubuntu-latest
          - os: windows
            arch: arm64
            runner: ubuntu-latest
          # macOS builds - use macOS runner
          - os: darwin
            arch: amd64
            runner: macos-latest
          - os: darwin
            arch: arm64
            runner: macos-latest
          # BSD builds
          - os: freebsd
            arch: amd64
            runner: ubuntu-latest
          - os: freebsd
            arch: 386
            runner: ubuntu-latest
          - os: freebsd
            arch: arm64
            runner: ubuntu-latest
          - os: netbsd
            arch: amd64
            runner: ubuntu-latest
          - os: netbsd
            arch: 386
            runner: ubuntu-latest
          - os: netbsd
            arch: arm64
            runner: ubuntu-latest
          - os: openbsd
            arch: amd64
            runner: ubuntu-latest
          - os: openbsd
            arch: 386
            runner: ubuntu-latest
          - os: openbsd
            arch: arm64
            runner: ubuntu-latest
          # Android builds
          - os: android
            arch: amd64
            runner: ubuntu-latest
          - os: android
            arch: arm64
            runner: ubuntu-latest
          - os: android
            arch: 386
            runner: ubuntu-latest
          - os: android
            arch: arm
            runner: ubuntu-latest

    runs-on: ${{ matrix.runner }}
    
    env:
      GOOS: ${{ matrix.os }}
      GOARCH: ${{ matrix.arch }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.1'

      - name: Install Linux deps (fpm, dpkg, appimage, flatpak)
        if: matrix.os == 'linux' && matrix.runner == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential dpkg-dev libfuse2 flatpak-builder
          sudo gem install --no-document fpm
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          sudo mv appimagetool-x86_64.AppImage /usr/local/bin/appimagetool
          
          # Setup Flatpak properly
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08

      - name: Setup Android NDK (only for android)
        if: matrix.os == 'android'
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget
          ANDROID_NDK_VERSION=r25b
          wget https://dl.google.com/android/repository/android-ndk-${ANDROID_NDK_VERSION}-linux.zip
          unzip android-ndk-${ANDROID_NDK_VERSION}-linux.zip
          echo "ANDROID_NDK_HOME=$(pwd)/android-ndk-${ANDROID_NDK_VERSION}" >> $GITHUB_ENV
          export ANDROID_NDK_HOME=$(pwd)/android-ndk-${ANDROID_NDK_VERSION}

      - name: Build binary
        run: |
          mkdir -p dist
          EXT=""
          if [ "$GOOS" = "windows" ]; then EXT=".exe"; fi

          if [ "$GOOS" = "android" ]; then
            export CGO_ENABLED=1
            export ANDROID_NDK_HOME=$ANDROID_NDK_HOME
            export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH

            case "$GOARCH" in
              amd64)
                export CC=x86_64-linux-android21-clang
                ;;
              arm64)
                export CC=aarch64-linux-android21-clang
                ;;
              386)
                export CC=i686-linux-android21-clang
                ;;
              arm)
                export CC=armv7a-linux-androideabi21-clang
                ;;
            esac

            GOOS=android GOARCH=$GOARCH CGO_ENABLED=1 CC=$CC go build -o dist/aether-${GOOS}_${GOARCH}${EXT} ./cmd/aether2/
          else
            CGO_ENABLED=0 GOOS=$GOOS GOARCH=$GOARCH go build -o dist/aether-${GOOS}_${GOARCH}${EXT} ./cmd/aether2/
          fi

      - name: Package formats for Linux
        if: matrix.os == 'linux' && matrix.runner == 'ubuntu-latest'
        run: |
          # Create AETHERROOT directory structure
          mkdir -p dist/pkgroot/usr/local/aether/bin
          mkdir -p dist/pkgroot/usr/local/aether/packages
          cp dist/aether-${GOOS}_${GOARCH} dist/pkgroot/usr/local/aether/bin/aether
          cp -r packages/* dist/pkgroot/usr/local/aether/packages/
          
          # Create symlink for backwards compatibility
          mkdir -p dist/pkgroot/usr/local/bin
          ln -sf /usr/local/aether/bin/aether dist/pkgroot/usr/local/bin/aether

          # DEB package
          mkdir -p dist/deb/DEBIAN
          cat > dist/deb/DEBIAN/control <<EOF
          Package: aether
          Version: 1.0.0
          Section: base
          Priority: optional
          Architecture: ${GOARCH}
          Maintainer: Aether Dev <noreply@aether.org>
          Description: Aether Programming Language Binary
          EOF
          mkdir -p dist/deb/usr/local/aether/bin
          mkdir -p dist/deb/usr/local/aether/packages
          mkdir -p dist/deb/usr/local/bin
          cp dist/aether-${GOOS}_${GOARCH} dist/deb/usr/local/aether/bin/aether
          cp -r packages/* dist/deb/usr/local/aether/packages/
          ln -sf /usr/local/aether/bin/aether dist/deb/usr/local/bin/aether
          dpkg-deb --build dist/deb dist/aether-${GOOS}_${GOARCH}.deb

          # RPM package
          mkdir -p dist/rpm_staging/usr/local/aether/bin
          mkdir -p dist/rpm_staging/usr/local/aether/packages
          mkdir -p dist/rpm_staging/usr/local/bin
          cp dist/aether-${GOOS}_${GOARCH} dist/rpm_staging/usr/local/aether/bin/aether
          cp -r packages/* dist/rpm_staging/usr/local/aether/packages/
          ln -sf /usr/local/aether/bin/aether dist/rpm_staging/usr/local/bin/aether
          fpm -s dir -t rpm -n aether -v 1.0.0 --architecture ${GOARCH} -C dist/rpm_staging -p dist/aether-${GOOS}_${GOARCH}.rpm .

          # Flatpak package (only for x86_64 and aarch64)
          if [ "$GOARCH" = "amd64" ] || [ "$GOARCH" = "arm64" ]; then
            # Create required assets directory if it doesn't exist
            mkdir -p assets
            
            # Create a simple icon if it doesn't exist
            if [ ! -f assets/icon-256x256.png ]; then
              # Create a simple placeholder icon using convert (ImageMagick)
              sudo apt-get install -y imagemagick
              convert -size 256x256 xc:blue -fill white -pointsize 48 -gravity center -annotate +0+0 "A" assets/icon-256x256.png
            fi
            
            # Create Flatpak manifest
            mkdir -p flatpak
            cat > flatpak/org.aether.Aether.yaml <<EOF
          app-id: org.aether.Aether
          runtime: org.freedesktop.Platform
          runtime-version: '23.08'
          sdk: org.freedesktop.Sdk
          command: aether
          
          finish-args:
            - --share=ipc
            - --socket=x11
            - --socket=wayland
            - --filesystem=home
            - --filesystem=xdg-documents
            - --filesystem=xdg-desktop
            - --filesystem=xdg-download
            - --share=network
          
          modules:
            - name: aether
              buildsystem: simple
              build-commands:
                - install -D aether /app/bin/aether
                - mkdir -p /app/share/aether
                - cp -r packages/* /app/share/aether/
                - install -D org.aether.Aether.desktop /app/share/applications/org.aether.Aether.desktop
                - install -D icon-256x256.png /app/share/icons/hicolor/256x256/apps/org.aether.Aether.png
              sources:
                - type: file
                  path: ../dist/aether-${GOOS}_${GOARCH}
                  dest-filename: aether
                - type: dir
                  path: ../packages
                  dest: packages
                - type: file
                  path: ../assets/icon-256x256.png
                - type: file
                  path: org.aether.Aether.desktop
          EOF

            # Create desktop file for Flatpak
            cat > flatpak/org.aether.Aether.desktop <<EOF
          [Desktop Entry]
          Name=Aether
          Comment=Aether Programming Language
          Exec=aether
          Icon=org.aether.Aether
          Terminal=true
          Type=Application
          Categories=Development;Programming;
          EOF

            # Set Flatpak architecture
            FLATPAK_ARCH="$GOARCH"
            if [ "$GOARCH" = "amd64" ]; then FLATPAK_ARCH="x86_64"; fi
            if [ "$GOARCH" = "arm64" ]; then FLATPAK_ARCH="aarch64"; fi

            # Build Flatpak with proper error handling
            cd flatpak
            if flatpak-builder --arch="$FLATPAK_ARCH" --repo=../dist/flatpak-repo --force-clean build org.aether.Aether.yaml; then
              flatpak build-bundle ../dist/flatpak-repo ../dist/aether-${GOOS}_${GOARCH}.flatpak org.aether.Aether
              echo "Flatpak build successful"
            else
              echo "Flatpak build failed, but continuing with other packages"
            fi
            cd ..
          else
            echo "Skipping Flatpak build for $GOARCH - not supported on Flathub"
          fi

          # AppImage (if supported)
          if [ "$GOARCH" != "riscv64" ] && [ "$GOARCH" != "ppc64le" ]; then
            mkdir -p AppDir/usr/bin
            cp dist/aether-${GOOS}_${GOARCH} AppDir/usr/bin/aether
            
            # Use the same icon as Flatpak or create a simple one
            if [ -f assets/icon-256x256.png ]; then
              cp assets/icon-256x256.png AppDir/icon-256x256.png
            else
              # Create a simple placeholder icon
              sudo apt-get install -y imagemagick
              convert -size 256x256 xc:blue -fill white -pointsize 48 -gravity center -annotate +0+0 "A" AppDir/icon-256x256.png
            fi
            
            cat > AppDir/aether.desktop <<EOF
          [Desktop Entry]
          Name=Aether
          Exec=aether
          Icon=icon-256x256
          Type=Application
          Categories=Development;
          EOF

            ARCH="$GOARCH"
            if [ "$GOARCH" = "amd64" ]; then ARCH="x86_64"; fi
            if [ "$GOARCH" = "386" ]; then ARCH="i686"; fi
            if [ "$GOARCH" = "arm" ]; then ARCH="armhf"; fi
            if [ "$GOARCH" = "arm64" ]; then ARCH="arm_aarch64"; fi
            if [ "$GOARCH" = "ppc64le" ]; then ARCH="ppc64le"; fi

            export ARCH
            if appimagetool AppDir dist/aether-"${GOOS}"_"${GOARCH}".appimage; then
              echo "AppImage build successful"
            else
              echo "AppImage build failed, but continuing with other packages"
            fi
          else
            echo "Skipping AppImage build for $GOARCH - not supported"
          fi

          # Tarball with full AETHERROOT structure
          mkdir -p tarball/usr/local/aether/bin
          mkdir -p tarball/usr/local/aether/packages
          mkdir -p tarball/usr/local/bin
          cp dist/aether-${GOOS}_${GOARCH} tarball/usr/local/aether/bin/aether
          cp -r packages/* tarball/usr/local/aether/packages/
          ln -sf /usr/local/aether/bin/aether tarball/usr/local/bin/aether
          tar -cvf dist/aether-${GOOS}_${GOARCH}.tar -C tarball .

      - name: Package formats for macOS
        if: matrix.os == 'darwin' && matrix.runner == 'macos-latest'
        run: |
          EXT=""
          BIN=dist/aether-${GOOS}_${GOARCH}${EXT}
          
          # Create AETHERROOT directory structure
          mkdir -p dist/macos_pkgroot/usr/local/aether/bin
          mkdir -p dist/macos_pkgroot/usr/local/aether/packages
          mkdir -p dist/macos_pkgroot/usr/local/bin
          cp "$BIN" dist/macos_pkgroot/usr/local/aether/bin/aether
          cp -r packages/* dist/macos_pkgroot/usr/local/aether/packages/
          ln -sf /usr/local/aether/bin/aether dist/macos_pkgroot/usr/local/bin/aether

          # PKG installer
          pkgbuild \
            --identifier org.aether.pkg \
            --version 1.0.0 \
            --install-location / \
            --root dist/macos_pkgroot \
            dist/aether-${GOOS}_${GOARCH}.pkg

          # DMG with full structure
          mkdir -p dmg/usr/local/aether/bin
          mkdir -p dmg/usr/local/aether/packages
          mkdir -p dmg/usr/local/bin
          cp "$BIN" dmg/usr/local/aether/bin/aether
          cp -r packages/* dmg/usr/local/aether/packages/
          ln -sf /usr/local/aether/bin/aether dmg/usr/local/bin/aether
          hdiutil create -volname Aether \
            -srcfolder dmg \
            -ov \
            -format UDZO \
            dist/aether-${GOOS}_${GOARCH}.dmg

          # Tarball with full AETHERROOT structure
          mkdir -p tarball/usr/local/aether/bin
          mkdir -p tarball/usr/local/aether/packages
          mkdir -p tarball/usr/local/bin
          cp "$BIN" tarball/usr/local/aether/bin/aether
          cp -r packages/* tarball/usr/local/aether/packages/
          ln -sf /usr/local/aether/bin/aether tarball/usr/local/bin/aether
          tar -cvf dist/aether-${GOOS}_${GOARCH}.tar -C tarball .

      - name: Package formats for Windows
        if: matrix.os == 'windows' && matrix.runner == 'ubuntu-latest'
        run: |
          # Create Windows directory structure (C:\Program Files\Aether equivalent)
          mkdir -p tarball/Program\ Files/Aether/bin
          mkdir -p tarball/Program\ Files/Aether/packages
          cp dist/aether-${GOOS}_${GOARCH}.exe "tarball/Program Files/Aether/bin/aether.exe"
          cp -r packages/* "tarball/Program Files/Aether/packages/"
          
          # Create a batch file for easier access
          cat > "tarball/Program Files/Aether/aether.bat" <<EOF
          @echo off
          set AETHERROOT=%~dp0
          "%AETHERROOT%bin\aether.exe" %*
          EOF
          
          tar -cvf dist/aether-${GOOS}_${GOARCH}.tar -C tarball .

      - name: Package formats for BSD and Android
        if: contains('freebsd netbsd openbsd android', matrix.os)
        run: |
          EXT=""
          if [ "$GOOS" = "windows" ]; then EXT=".exe"; fi
          
          # Create AETHERROOT directory structure
          mkdir -p tarball/usr/local/aether/bin
          mkdir -p tarball/usr/local/aether/packages
          mkdir -p tarball/usr/local/bin
          cp dist/aether-${GOOS}_${GOARCH}${EXT} tarball/usr/local/aether/bin/aether
          cp -r packages/* tarball/usr/local/aether/packages/
          ln -sf /usr/local/aether/bin/aether tarball/usr/local/bin/aether
          tar -cvf dist/aether-${GOOS}_${GOARCH}.tar -C tarball .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aether-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            dist/aether-${{ matrix.os }}_${{ matrix.arch }}*

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: List downloaded files
        run: ls -R dist

      - name: Flatten artifacts
        run: |
          mkdir flat
          find dist -type f -exec cp {} flat/ \;
          rm -rf dist
          mv flat dist

      - name: Create GitHub Release and upload files
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: dist/*
          draft: false
          prerelease: ${{ contains(github.ref_name, 'nightly') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
